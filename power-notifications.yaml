blueprint:
  name: Power-dependant state notification
  description: Send a notification based on the power level of a device
  domain: automation
  source_url: https://github.com/tlanfer/ha-blueprints/blob/main/power-notifications.yaml
  author: tlanfer

  input:
    power_entity:
      name: Power sensor
      selector:
        entity:
          filter:
            device_class: power
            domain: sensor

    power_level:
      name: Power threshold
      description: At what threshold should the device be considered powered on
      default: 10
      selector:
        number:
          min: 0
          max: 1000
          unit_of_measurement: watt

    power_on_duration:
      name: Power on duration
      description: How long to be above the threshold
      default: 5
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: seconds

    power_off_duration:
      name: Power off duration
      description: How long to be below the threshold
      default: 5
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: seconds

    notification_device:
      name: Devices
      description: Devices to notify when done
      selector:
        device:
          filter:
            integration: mobile_app

    notification_title:
      name: Notification title
      description: Title for the notification
      default: ""
      selector:
        text:

    notification_message_template:
      name: Notification body
      description: Allows templating.
      selector:
        text:
          multiline: true

mode: restart

trigger:
  platform: numeric_state
  entity_id: !input power_entity
  above: !input power_level
  for: !input power_on_duration

action:
  - alias: "Wait for power to fall"
    wait_for_trigger:
      - platform: numeric_state
        entity_id: !input power_entity
        below: !input power_level
        for: !input power_off_duration
    timeout:
      hours: 24
    continue_on_timeout: false
  - alias: "Notify"
    domain: mobile_app
    type: notify
    device_id: !input notification_device
    title: !input notification_title
    message: !input notification_message_template